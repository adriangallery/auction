<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Aprobar y Swapear Tokens</title>
  <!-- Incluir ethers.js desde CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h1>Aprobar y Swapear Tokens</h1>
  <button id="connectWallet">Conectar Wallet</button>
  <div id="walletAddress"></div>
  <br>
  <label for="amount">Cantidad de tokens a swapear:</label>
  <input type="number" id="amount" placeholder="Ingrese cantidad" />
  <button id="actionButton">Aprobar y Swapear</button>
  
  <script>
    // Direcciones: contrato swap y token A
    const swapContractAddress = "0x7F17C51B916E17689d844B33Cf5BF9d3f1E08430";
    const tokenAAddress = "0x948686aACc0093AC0c26387c302a5C19f8dbD170";
    
    // ABI mínima para la función swap del contrato TokenSwap
    const swapAbi = [
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "amount",
            "type": "uint256"
          }
        ],
        "name": "swap",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];
    
    // ABI mínima ERC20 para la función approve
    const erc20Abi = [
      "function approve(address spender, uint256 amount) external returns (bool)"
    ];
    
    let provider;
    let signer;
    let swapContract;
    let tokenAContract;
    
    // Conectar con MetaMask
    document.getElementById("connectWallet").onclick = async () => {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        const address = await signer.getAddress();
        document.getElementById("walletAddress").innerText = "Conectado: " + address;
        // Instanciar los contratos
        swapContract = new ethers.Contract(swapContractAddress, swapAbi, signer);
        tokenAContract = new ethers.Contract(tokenAAddress, erc20Abi, signer);
      } else {
        alert("Necesitas instalar MetaMask");
      }
    };
    
    // Botón que ejecuta la aprobación y el swap
    document.getElementById("actionButton").onclick = async () => {
      if (!swapContract || !tokenAContract) {
        alert("Conecta tu wallet primero.");
        return;
      }
      
      const inputAmount = document.getElementById("amount").value;
      if (!inputAmount || inputAmount <= 0) {
        alert("Introduce una cantidad válida.");
        return;
      }
      
      // Convertir la cantidad a unidades mínimas (suponiendo 18 decimales)
      const amount = ethers.utils.parseUnits(inputAmount, 18);
      
      try {
        // Primera transacción: aprobar el gasto del token A para el contrato swap
        const approveTx = await tokenAContract.approve(swapContractAddress, amount);
        alert("Aprobación enviada: " + approveTx.hash);
        await approveTx.wait();
        alert("Aprobación completada, iniciando swap...");
        
        // Segunda transacción: ejecutar el swap
        const swapTx = await swapContract.swap(amount);
        alert("Swap enviado: " + swapTx.hash);
        await swapTx.wait();
        alert("Swap completado exitosamente.");
      } catch (error) {
        console.error(error);
        alert("Error: " + error.message);
      }
    };
  </script>
</body>
</html>
